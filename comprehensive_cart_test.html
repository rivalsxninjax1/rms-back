<!DOCTYPE html>
<html>
<head>
    <title>Comprehensive Cart Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Comprehensive Cart Test</h1>
    
    <div class="test-section">
        <h2>1. localStorage Test</h2>
        <div id="localStorage-test">Testing...</div>
    </div>
    
    <div class="test-section">
        <h2>2. Server API Test</h2>
        <div id="server-api-test">Testing...</div>
    </div>
    
    <div class="test-section">
        <h2>3. cartApiGet Function Test</h2>
        <div id="cartApiGet-test">Testing...</div>
    </div>
    
    <div class="test-section">
        <h2>4. Cart Render Test</h2>
        <div id="cart-render-test">Testing...</div>
        <div id="cart-items" style="border: 1px solid #eee; padding: 10px; margin-top: 10px;">
            <!-- Cart items will be rendered here -->
        </div>
    </div>
    
    <div class="test-section">
        <h2>5. Manual Cart Render</h2>
        <button onclick="manualRender()">Manually Trigger Cart Render</button>
        <div id="manual-render-result"></div>
    </div>
    
    <script>
        // Define cartApiGet globally (same as base.html)
        window.cartApiGet = async function cartApiGet(){
            console.log('cartApiGet called');
            
            // First try to get data from server
            const r = await fetch("/api/orders/cart-simple/", { 
                credentials: "include"
            });
            
            let serverData = { items: [] };
            if (r.ok) {
                serverData = await r.json();
                console.log('Server data:', serverData);
            } else {
                console.log('Server request failed:', r.status, r.statusText);
            }
            
            // If server has no items, check localStorage cart_v1
            if (!serverData.items || serverData.items.length === 0) {
                console.log('Server cart empty, checking localStorage');
                try {
                    const cartV1 = localStorage.getItem('cart_v1');
                    console.log('localStorage cart_v1:', cartV1);
                    
                    if (cartV1) {
                        const cart = JSON.parse(cartV1);
                        if (cart.items && typeof cart.items === 'object') {
                            console.log('Converting localStorage cart to API format');
                            // Convert cart_v1 format to expected format
                            const items = Object.entries(cart.items).map(([id, item]) => ({
                                id: parseInt(id),
                                name: item.name || `Item ${id}`,
                                quantity: item.qty || 0,
                                unit_price: item.price || 0,
                                line_total: (item.qty || 0) * (item.price || 0),
                                total_unit_price: item.price || 0,
                                modifier_price: 0,
                                modifier_names: []
                            }));
                            
                            const result = {
                                items: items,
                                subtotal: items.reduce((sum, item) => sum + (item.line_total || 0), 0).toFixed(2),
                                meta: cart
                            };
                            
                            console.log('Returning localStorage cart:', result);
                            return result;
                        }
                    }
                } catch (e) {
                    console.error('Error reading cart_v1 from localStorage:', e);
                }
            }
            
            console.log('Returning server data:', serverData);
            return serverData;
        }
        
        // Test functions
        async function testLocalStorage() {
            const testDiv = document.getElementById('localStorage-test');
            
            try {
                // Add test data
                const testCart = {
                    items: {
                        "1": { name: "Test Pizza", qty: 2, price: 15.99 },
                        "2": { name: "Test Burger", qty: 1, price: 12.50 }
                    }
                };
                
                localStorage.setItem('cart_v1', JSON.stringify(testCart));
                
                // Verify
                const stored = localStorage.getItem('cart_v1');
                const parsed = JSON.parse(stored);
                
                testDiv.innerHTML = `
                    <div class="success">✅ localStorage working</div>
                    <pre>${JSON.stringify(parsed, null, 2)}</pre>
                `;
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ localStorage error: ${error.message}</div>`;
            }
        }
        
        async function testServerAPI() {
            const testDiv = document.getElementById('server-api-test');
            
            try {
                const response = await fetch('/api/orders/cart-simple/', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                testDiv.innerHTML = `
                    <div class="info">Server Response (${response.status}):</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ Server API error: ${error.message}</div>`;
            }
        }
        
        async function testCartApiGet() {
            const testDiv = document.getElementById('cartApiGet-test');
            
            try {
                if (typeof window.cartApiGet === 'function') {
                    const result = await window.cartApiGet();
                    
                    testDiv.innerHTML = `
                        <div class="success">✅ cartApiGet function working</div>
                        <div class="info">Items found: ${result.items ? result.items.length : 0}</div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    testDiv.innerHTML = `<div class="error">❌ cartApiGet function not found</div>`;
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ cartApiGet error: ${error.message}</div>`;
            }
        }
        
        async function testCartRender() {
            const testDiv = document.getElementById('cart-render-test');
            
            try {
                // Check if cart-render.js functions are available
                const cartItemsDiv = document.getElementById('cart-items');
                
                if (cartItemsDiv) {
                    // Try to render cart manually
                    const data = await window.cartApiGet();
                    const items = Array.isArray(data.items) ? data.items : [];
                    
                    if (items.length > 0) {
                        const html = items.map(item => `
                            <div style="border-bottom: 1px solid #eee; padding: 10px;">
                                <strong>${item.name}</strong><br>
                                Quantity: ${item.quantity}<br>
                                Price: $${item.unit_price}<br>
                                Total: $${item.line_total}
                            </div>
                        `).join('');
                        
                        cartItemsDiv.innerHTML = html;
                        testDiv.innerHTML = `<div class="success">✅ Manual render successful (${items.length} items)</div>`;
                    } else {
                        cartItemsDiv.innerHTML = '<p>No items to display</p>';
                        testDiv.innerHTML = `<div class="info">ℹ️ No items to render</div>`;
                    }
                } else {
                    testDiv.innerHTML = `<div class="error">❌ cart-items div not found</div>`;
                }
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ Cart render error: ${error.message}</div>`;
            }
        }
        
        async function manualRender() {
            const resultDiv = document.getElementById('manual-render-result');
            
            try {
                const data = await window.cartApiGet();
                resultDiv.innerHTML = `
                    <div class="info">Manual render result:</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Also update the cart items display
                await testCartRender();
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Manual render error: ${error.message}</div>`;
            }
        }
        
        // Run all tests when page loads
        window.addEventListener('load', async () => {
            console.log('Starting comprehensive cart tests');
            
            await testLocalStorage();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testServerAPI();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCartApiGet();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCartRender();
        });
    </script>
</body>
</html>