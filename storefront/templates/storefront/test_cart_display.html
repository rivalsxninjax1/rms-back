{% extends "storefront/base.html" %}
{% load static %}

{% block title %}Test Cart Display{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 24px auto">
    <h1>Test Cart Display</h1>
    
    <div style="margin: 20px 0;">
        <button onclick="addTestItems()" class="btn btn-success">Add Test Items to localStorage</button>
        <button onclick="clearCart()" class="btn btn-danger">Clear Cart</button>
        <button onclick="manualRender()" class="btn btn-primary">Manual Render</button>
        <button onclick="checkCartState()" class="btn btn-info">Check Cart State</button>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <h3>Cart Items (Rendered by cart-render.js)</h3>
            <div id="cart-items" style="border: 2px solid #007bff; padding: 20px; margin: 20px 0; min-height: 200px; background: #f8f9fa;">
                <!-- Cart items will be rendered here by cart-render.js -->
            </div>
        </div>
        
        <div class="col-md-4">
            <h3>Debug Log</h3>
            <div id="debug-log" style="border: 1px solid #ccc; padding: 15px; height: 400px; overflow-y: auto; background: white; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>
    
    <div style="margin-top: 30px;">
        <h3>Raw Data</h3>
        <div id="raw-data" style="background: #f8f9fa; padding: 15px; border-radius: 5px;"></div>
    </div>
</div>

<script>
    let logCount = 0;
    
    function log(message, type = 'info') {
        logCount++;
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
            'info': '#007bff',
            'success': '#28a745',
            'error': '#dc3545',
            'warning': '#ffc107'
        };
        
        const logDiv = document.getElementById('debug-log');
        const logEntry = document.createElement('div');
        logEntry.style.borderLeft = `3px solid ${colors[type] || colors.info}`;
        logEntry.style.paddingLeft = '8px';
        logEntry.style.marginBottom = '5px';
        logEntry.innerHTML = `<strong>[${logCount}] ${timestamp}</strong><br>${message}`;
        
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function addTestItems() {
        const testCart = {
            items: {
                "1": { name: "Margherita Pizza", qty: 2, price: 15.99 },
                "2": { name: "Chicken Burger", qty: 1, price: 12.50 },
                "3": { name: "Caesar Salad", qty: 3, price: 8.75 },
                "4": { name: "Chocolate Cake", qty: 1, price: 6.99 }
            }
        };
        
        localStorage.setItem('cart_v1', JSON.stringify(testCart));
        log('‚úÖ Added test items to localStorage', 'success');
        log(`Items: ${Object.keys(testCart.items).length}`, 'info');
        
        // Trigger cart render after a short delay
        setTimeout(() => {
            log('üîÑ Triggering cart render...', 'info');
            if (window.renderCartList && typeof window.renderCartList === 'function') {
                window.renderCartList();
            } else {
                log('‚ö†Ô∏è renderCartList function not found, checking for cart-render.js execution', 'warning');
                checkCartRenderExecution();
            }
        }, 500);
    }
    
    function clearCart() {
        localStorage.removeItem('cart_v1');
        log('üóëÔ∏è Cleared cart from localStorage', 'info');
        
        // Clear the cart display
        const cartDiv = document.getElementById('cart-items');
        if (cartDiv) {
            cartDiv.innerHTML = '<p style="color: #666; font-style: italic;">Cart cleared</p>';
        }
        
        updateRawData();
    }
    
    async function manualRender() {
        log('üîß Starting manual render...', 'info');
        
        try {
            // Check if cartApiGet is available
            if (typeof window.cartApiGet !== 'function') {
                log('‚ùå cartApiGet function not available', 'error');
                return;
            }
            
            log('üì° Calling cartApiGet...', 'info');
            const cartData = await window.cartApiGet();
            log(`üì¶ Cart data received: ${cartData.items ? cartData.items.length : 0} items`, 'success');
            
            const cartDiv = document.getElementById('cart-items');
            if (!cartDiv) {
                log('‚ùå cart-items div not found', 'error');
                return;
            }
            
            if (!cartData.items || cartData.items.length === 0) {
                cartDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">Your cart is empty.</p>';
                log('‚ÑπÔ∏è Cart is empty', 'info');
                return;
            }
            
            // Manual render using the same logic as cart-render.js
            const itemsHtml = cartData.items.map(item => {
                const id = Number(item.id);
                const qty = Number(item.quantity || 0);
                const name = item.name || `Item ${id}`;
                const unit = Number(item.unit_price || 0).toFixed(2);
                const line = Number(item.line_total || (qty * Number(item.unit_price || 0))).toFixed(2);
                
                return `
                    <div class="cart-row" data-id="${id}" style="display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid #eee; padding:10px 0;">
                        <div style="flex:1;">
                            <div style="font-weight:600;">${name}</div>
                            <div style="color: #666; font-size: 14px;">NPR ${unit} each</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <button style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; cursor: pointer;">‚àí</button>
                            <span style="min-width:28px; text-align:center; font-weight: bold;">${qty}</span>
                            <button style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; cursor: pointer;">+</button>
                        </div>
                        <div style="min-width:120px; text-align:right; font-weight: bold;">NPR ${line}</div>
                        <button style="width: 30px; height: 30px; border: 1px solid #dc3545; background: #dc3545; color: white; cursor: pointer; margin-left:4px;">‚úï</button>
                    </div>
                `;
            }).join('');
            
            cartDiv.innerHTML = itemsHtml;
            log(`‚úÖ Manual render completed: ${cartData.items.length} items displayed`, 'success');
            
        } catch (error) {
            log(`‚ùå Manual render error: ${error.message}`, 'error');
        }
        
        updateRawData();
    }
    
    async function checkCartState() {
        log('üîç Checking cart state...', 'info');
        
        // Check localStorage
        const cartV1 = localStorage.getItem('cart_v1');
        if (cartV1) {
            try {
                const parsed = JSON.parse(cartV1);
                const itemCount = Object.keys(parsed.items || {}).length;
                log(`üì± localStorage cart_v1: ${itemCount} items`, 'success');
            } catch (e) {
                log(`‚ùå localStorage cart_v1 parse error: ${e.message}`, 'error');
            }
        } else {
            log('üì± No cart_v1 in localStorage', 'warning');
        }
        
        // Check cartApiGet
        if (typeof window.cartApiGet === 'function') {
            try {
                const result = await window.cartApiGet();
                log(`üåê cartApiGet result: ${result.items ? result.items.length : 0} items`, 'success');
            } catch (error) {
                log(`‚ùå cartApiGet error: ${error.message}`, 'error');
            }
        } else {
            log('‚ùå cartApiGet function not available', 'error');
        }
        
        // Check cart-items div content
        const cartDiv = document.getElementById('cart-items');
        if (cartDiv) {
            const contentLength = cartDiv.innerHTML.trim().length;
            log(`üìÑ cart-items div content: ${contentLength} characters`, contentLength > 0 ? 'success' : 'warning');
        }
        
        // Check if cart-render.js bound
        log(`üîß __CART_RENDER_BOUND__: ${window.__CART_RENDER_BOUND__ || 'false'}`, window.__CART_RENDER_BOUND__ ? 'success' : 'warning');
        
        updateRawData();
    }
    
    function checkCartRenderExecution() {
        log('üîç Checking cart-render.js execution...', 'info');
        
        // Check if cart-render.js has executed
        if (window.__CART_RENDER_BOUND__) {
            log('‚úÖ cart-render.js has executed and bound', 'success');
        } else {
            log('‚ö†Ô∏è cart-render.js may not have executed yet', 'warning');
        }
        
        // Check for cart-render.js in loaded scripts
        const scripts = Array.from(document.scripts)
            .map(s => s.src)
            .filter(s => s && s.includes('cart-render'));
        
        if (scripts.length > 0) {
            log(`‚úÖ cart-render.js script found: ${scripts[0]}`, 'success');
        } else {
            log('‚ùå cart-render.js script not found', 'error');
        }
    }
    
    async function updateRawData() {
        const rawDiv = document.getElementById('raw-data');
        let html = '<h4>Raw Data:</h4>';
        
        // localStorage data
        const cartV1 = localStorage.getItem('cart_v1');
        html += '<h5>localStorage cart_v1:</h5>';
        if (cartV1) {
            html += `<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto;">${JSON.stringify(JSON.parse(cartV1), null, 2)}</pre>`;
        } else {
            html += '<p style="color: #666;">No data</p>';
        }
        
        // cartApiGet result
        html += '<h5>cartApiGet() result:</h5>';
        if (typeof window.cartApiGet === 'function') {
            try {
                const result = await window.cartApiGet();
                html += `<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>`;
            } catch (error) {
                html += `<p style="color: #dc3545;">Error: ${error.message}</p>`;
            }
        } else {
            html += '<p style="color: #666;">cartApiGet not available</p>';
        }
        
        rawDiv.innerHTML = html;
    }
    
    // Initialize when page loads
    window.addEventListener('load', () => {
        log('üöÄ Test page loaded', 'success');
        
        setTimeout(() => {
            checkCartState();
            updateRawData();
        }, 1000);
    });
    
    // Override console.log to capture cart-render.js logs
    const originalConsoleLog = console.log;
    console.log = function(...args) {
        originalConsoleLog.apply(console, args);
        
        const message = args.join(' ');
        if (message.includes('cart') || message.includes('Cart') || message.includes('render')) {
            log(`üîß Console: ${message}`, 'info');
        }
    };
    
    log('üîß Test script initialized', 'info');
</script>
{% endblock %}