{% extends "storefront/base.html" %} {% load static %} {% block title %}Your
Cart – RMS{% endblock %} {% block content %}
{% csrf_token %}
<div class="container" style="max-width: 800px; margin: 24px auto">
  <div
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    "
  >
    <h1 style="margin: 0">Your Cart</h1>
    <a
      href="{% url 'storefront:menu' %}"
      style="color: #007bff; text-decoration: none"
      >← Continue Shopping</a
    >
  </div>

  <!-- Cart Items Table -->
  <div id="cart-container">
    <div
      id="cart-empty"
      style="text-align: center; padding: 40px; display: none"
    >
      <h3 style="color: #666">Your cart is empty</h3>
      <p>Add some delicious items from our menu!</p>
      <a href="{% url 'storefront:menu' %}" class="btn btn-primary"
        >Browse Menu</a
      >
    </div>

    <div id="cart-items" style="margin-bottom: 20px;">
      <!-- Cart items will be populated by cart-render.js -->
    </div>

    <!-- Extras Section -->
    <div id="extras-section" style="border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 20px; display: none;">
      <h3 style="margin: 0 0 16px; font-size: 18px">Add Extras</h3>
      <div id="extras-container">
        <!-- Extras will be populated by JavaScript -->
      </div>
      <div id="extras-total" style="text-align: right; margin-top: 16px; font-weight: 600; display: none;">
        Extras Total: $<span id="extras-total-amount">0.00</span>
      </div>
    </div>

      <!-- Order Options -->
      <div
        style="
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
        "
      >
        <h3 style="margin: 0 0 16px; font-size: 18px">Order Options</h3>

        <!-- Delivery Method -->
        <div style="margin-bottom: 16px">
          <label style="display: block; font-weight: 600; margin-bottom: 8px"
            >Delivery Method</label
          >
          <div>
            <label style="margin-right: 16px; font-weight: normal">
              <input
                type="radio"
                name="delivery_method"
                value="DINE_IN"
                data-delivery="DINE_IN"
                checked
              />
              Dine In
            </label>
            <label style="margin-right: 16px; font-weight: normal">
              <input
                type="radio"
                name="delivery_method"
                value="TAKEAWAY"
                data-delivery="TAKEAWAY"
              />
              Takeaway
            </label>
            <label style="font-weight: normal">
              <input
                type="radio"
                name="delivery_method"
                value="DELIVERY"
                data-delivery="DELIVERY"
              />
              Delivery
            </label>
          </div>
        </div>

        <!-- Table Selection (only visible for Dine In) -->
        <div id="table-selection-container" style="margin-bottom: 16px">
          <label style="display: block; font-weight: 600; margin-bottom: 8px"
            >Choose Your Table</label
          >
          <select id="tableSelect" name="table" class="form-control">
            <option value="">Loading tables...</option>
          </select>
          <div
            id="table-message"
            style="margin-top: 8px; font-size: 14px; color: #666"
          >
            Please select a table for your dine-in order.
          </div>
        </div>

        <!-- Coupon Code -->
        <div style="margin-bottom: 16px">
          <label style="display: block; font-weight: 600; margin-bottom: 8px"
            >Coupon Code</label
          >
          <div style="display: flex; gap: 8px">
            <input
              id="coupon-input"
              type="text"
              placeholder="Enter coupon code"
              style="
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
            <button id="apply-coupon-btn" class="btn btn-secondary">
              Apply
            </button>
          </div>
          <div
            id="coupon-message"
            style="margin-top: 8px; font-size: 14px"
          ></div>
        </div>

        <!-- Tip -->
        <div style="margin-bottom: 16px">
          <label style="display: block; font-weight: 600; margin-bottom: 8px"
            >Add Tip</label
          >
          <div style="display: flex; gap: 8px; align-items: center">
            <input
              id="tip-input"
              type="number"
              min="0"
              step="0.01"
              value="0"
              data-tip
              style="
                width: 120px;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
              "
            />
            <span>NPR</span>
            <div style="margin-left: 16px">
              <button type="button" onclick="setTipPercent(10)" class="btn-tip">
                10%
              </button>
              <button type="button" onclick="setTipPercent(15)" class="btn-tip">
                15%
              </button>
              <button type="button" onclick="setTipPercent(20)" class="btn-tip">
                20%
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Cart Totals -->
      <div
        style="
          border: 1px solid #eee;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
          background: #f9f9f9;
        "
      >
        <h3 style="margin: 0 0 16px; font-size: 18px">Order Summary</h3>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
          "
        >
          <span>Subtotal:</span>
          <span data-cart-subtotal>NPR 0.00</span>
        </div>
        <div
          id="discount-row"
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #10b981;
            display: none;
          "
        >
          <span>Discount:</span>
          <span>-NPR <span data-cart-discount>0.00</span></span>
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
          "
        >
          <span>Tip:</span>
          <span data-cart-tip>NPR 0.00</span>
        </div>
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #ddd" />
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
          "
        >
          <span>Total:</span>
          <span data-cart-total>NPR 0.00</span>
        </div>
      </div>

      <!-- Cart Actions -->
      <div style="display: flex; gap: 12px; justify-content: flex-end">
        <button data-cart-clear class="btn btn-outline">Clear Cart</button>
        <button
          id="checkout-btn"
          class="btn btn-primary"
          style="padding: 12px 24px"
        >
          Proceed to Checkout
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .muted {
    color: #666;
  }
  .btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }

  .btn-primary {
    background: #007bff;
    color: white;
  }

  .btn-primary:hover {
    background: #0056b3;
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #545b62;
    transform: translateY(-1px);
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-outline {
    background: transparent;
    color: #6c757d;
    border: 1px solid #6c757d;
  }

  .btn-outline:hover {
    background: #6c757d;
    color: white;
  }

  .btn-tip {
    background: #f8f9fa;
    border: 1px solid #ddd;
    padding: 4px 8px;
    margin: 0 2px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .btn-tip:hover {
    background: #e9ecef;
  }

  .form-control {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }

  .alert {
    padding: 12px;
    border-radius: 6px;
    margin: 8px 0;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .cart-item {
    border-bottom: 1px solid #eee;
    padding: 16px 0;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .cart-item:last-child {
    border-bottom: none;
  }

  .cart-item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    background: #f5f5f5;
  }

  .cart-item-details {
    flex: 1;
  }

  .cart-item-name {
    font-weight: 600;
    margin-bottom: 4px;
  }

  .cart-item-price {
    color: #666;
    font-size: 14px;
  }

  .qty-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .qty-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: #f8f9fa;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .qty-btn:hover {
    background: #e9ecef;
  }

  .qty-input {
    width: 60px;
    text-align: center;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  /* Enhanced cart item styles */
  .cart-row:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
    margin: 0 -8px;
    padding: 12px 8px !important;
  }
  
  .qty-controls button:hover {
    background: #e9ecef !important;
    border-color: #adb5bd !important;
    transform: scale(1.05);
  }
  
  .remove-item:hover {
    background: #c82333 !important;
    transform: scale(1.1);
  }
  
  .extras-toggle:hover {
    color: #0056b3 !important;
  }
  
  /* Smooth transitions for cart items */
  .cart-row {
    transition: all 0.2s ease;
  }
  
  .item-image img {
    transition: transform 0.2s ease;
  }
  
  .cart-row:hover .item-image img {
    transform: scale(1.05);
  }
</style>

<script>
  // Cart rendering for cart page - disabled to avoid conflict with cart-render.js
  // The cart-render.js handles rendering using server session data
  function renderCartPage() {
    // This function is now disabled to prevent conflicts
    // cart-render.js handles the cart rendering
    console.log('renderCartPage called but disabled - cart-render.js handles rendering');
  }

  async function updateCartTotals() {
    try {
      // Get server-side calculated totals
      const data = await window.cartApiGet();
      const subtotal = parseFloat(data.subtotal || 0);
      const tipAmount = parseFloat(data.tip_amount || 0);
      const grandTotal = parseFloat(data.grand_total || 0);
      const itemCount = (data.items || []).length;

      document.querySelectorAll("[data-cart-subtotal]").forEach((el) => {
        el.textContent = "NPR " + subtotal.toFixed(2);
      });

      document.querySelectorAll("[data-cart-tip]").forEach((el) => {
        el.textContent = "NPR " + tipAmount.toFixed(2);
      });

      document.querySelectorAll("[data-cart-total]").forEach((el) => {
        el.textContent = "NPR " + grandTotal.toFixed(2);
      });

      // Show/hide discount row (keeping existing logic for now)
      const discountRow = document.getElementById("discount-row");
      if (discountRow) {
        // For now, keep discount hidden as it's not implemented in server response
        discountRow.style.display = "none";
      }

      // Enable/disable checkout button
      const checkoutBtn = document.getElementById("checkout-btn");
      if (checkoutBtn) {
        checkoutBtn.disabled = itemCount === 0;
      }
    } catch (error) {
      console.error('Error updating cart totals:', error);
      // Fallback to local cart if server fails
      const snap = cart.snapshot();
      document.querySelectorAll("[data-cart-subtotal]").forEach((el) => {
        el.textContent = "NPR " + money(snap.subtotal);
      });
      document.querySelectorAll("[data-cart-tip]").forEach((el) => {
        el.textContent = "NPR " + money(snap.tip);
      });
      document.querySelectorAll("[data-cart-total]").forEach((el) => {
        el.textContent = "NPR " + money(snap.total);
      });
    }
  }

  // Tip percentage helpers
  async function setTipPercent(percent) {
    try {
      // Get current server-side subtotal
      const data = await window.cartApiGet();
      const subtotal = parseFloat(data.subtotal || 0);
      const tipAmount = subtotal * (percent / 100);
      
      // Update tip on server
      await setTipAmount(tipAmount);
      
      const tipInput = document.getElementById("tip-input");
      if (tipInput) {
        tipInput.value = tipAmount.toFixed(2);
      }
    } catch (error) {
      console.error('Error setting tip percentage:', error);
    }
  }
  
  // Set tip amount on server and update totals
  async function setTipAmount(amount) {
    try {
      const response = await fetch('/api/cart/set-tip/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        credentials: 'include',
        body: JSON.stringify({ tip_amount: amount.toString() })
      });
      
      if (response.ok) {
        // Update totals display
        await updateCartTotals();
      } else {
        console.error('Failed to set tip amount');
      }
    } catch (error) {
      console.error('Error setting tip amount:', error);
    }
  }

  // Apply coupon
  async function applyCoupon() {
    const couponInput = document.getElementById("coupon-input");
    const couponMessage = document.getElementById("coupon-message");
    const applyBtn = document.getElementById("apply-coupon-btn");

    if (!couponInput || !couponMessage) return;

    const code = couponInput.value.trim();
    if (!code) {
      couponMessage.textContent = "Please enter a coupon code";
      couponMessage.style.color = "#dc3545";
      return;
    }

    applyBtn.disabled = true;
    applyBtn.textContent = "Applying...";

    try {
      const { res, data } = await api("/coupons/validate/", {
        method: "POST",
        body: JSON.stringify({ code: code, cart_total: cart.subtotal() }),
      });

      if (res.ok && data.valid) {
        cart.setDiscount(data.discount_amount);
        couponMessage.textContent = `✅ ${
          data.message || "Coupon applied successfully!"
        }`;
        couponMessage.style.color = "#10b981";
        couponInput.disabled = true;
      } else {
        couponMessage.textContent = data.message || "Invalid coupon code";
        couponMessage.style.color = "#dc3545";
      }
    } catch (error) {
      couponMessage.textContent = "Error applying coupon";
      couponMessage.style.color = "#dc3545";
    } finally {
      applyBtn.disabled = false;
      applyBtn.textContent = "Apply";
    }
  }

  // Initialize cart page
  document.addEventListener("DOMContentLoaded", async function () {
    // Sync localStorage cart to session before rendering
    if (window.cart && window.cart.snapshot) {
      const cartItems = window.cart.snapshot();
      if (cartItems.length > 0) {
        try {
          // Include selected modifiers in sync if available
          const itemsWithModifiers = cartItems.map(item => {
            const syncItem = { ...item };
            // Get selected modifiers if extras functionality is available
            if (window.getSelectedModifiers) {
              const selectedModifiers = window.getSelectedModifiers();
              if (selectedModifiers.length > 0) {
                syncItem.modifiers = selectedModifiers;
              }
            }
            return syncItem;
          });
          
          await fetch("/api/cart/sync/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]')?.value || ""
            },
            body: JSON.stringify({ items: itemsWithModifiers })
          });
        } catch (e) {
          console.error("Cart sync failed:", e);
        }
      }
    }

    // Initial render disabled - cart-render.js handles this
    // renderCartPage();

    // Listen for cart changes - disabled to prevent conflicts
    // window.addEventListener("cart:change", renderCartPage);

    // Coupon application
    const applyBtn = document.getElementById("apply-coupon-btn");
    if (applyBtn) {
      applyBtn.addEventListener("click", applyCoupon);
    }

    // Enter key on coupon input
    const couponInput = document.getElementById("coupon-input");
    if (couponInput) {
      couponInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          applyCoupon();
        }
      });
    }

    // Tip input event listener
    const tipInput = document.getElementById("tip-input");
    if (tipInput) {
      tipInput.addEventListener("input", async function () {
        const amount = parseFloat(this.value) || 0;
        await setTipAmount(amount);
      });
    }

    // Checkout button
    const checkoutBtn = document.getElementById("checkout-btn");
    if (checkoutBtn) {
      checkoutBtn.addEventListener("click", function () {
        window.location.href = '{% url "storefront:checkout" %}';
      });
    }
    
    // Initial totals update
    setTimeout(async () => {
      await updateCartTotals();
    }, 500);
  });
  
  // Update totals when cart changes
  if (window.addEventListener) {
    window.addEventListener("cart:change", async () => {
      await updateCartTotals();
    });
  }
</script>
{% endblock %}
