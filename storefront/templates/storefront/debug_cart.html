{% extends "storefront/base.html" %}
{% load static %}

{% block title %}Debug Cart Render{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 24px auto">
    <h1>Cart Render Debug</h1>
    
    <div id="cart-items" style="border: 1px solid #eee; padding: 20px; margin: 20px 0;">
        <!-- Cart items will be rendered here -->
    </div>
    
    <div id="debug-output" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;"></div>
    
    <div style="margin: 20px 0;">
        <button onclick="testCartRender()" class="btn btn-primary">Test Cart Render</button>
        <button onclick="checkScripts()" class="btn btn-secondary">Check Scripts</button>
        <button onclick="clearLogs()" class="btn btn-outline-secondary">Clear Logs</button>
        <button onclick="addTestData()" class="btn btn-success">Add Test Data</button>
    </div>
</div>

<script>
    // Override console.log to capture output
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    const logs = [];
    
    function addLog(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        logs.push({ type, message, timestamp });
        updateDebugOutput();
    }
    
    console.log = function(...args) {
        originalLog.apply(console, args);
        addLog('log', args.join(' '));
    };
    
    console.error = function(...args) {
        originalError.apply(console, args);
        addLog('error', args.join(' '));
    };
    
    console.warn = function(...args) {
        originalWarn.apply(console, args);
        addLog('warning', args.join(' '));
    };
    
    function updateDebugOutput() {
        const output = document.getElementById('debug-output');
        const logColors = {
            'log': '#007bff',
            'error': '#dc3545',
            'warning': '#ffc107'
        };
        
        output.innerHTML = logs.map(log => 
            `<div style="border-left: 4px solid ${logColors[log.type] || '#007bff'}; padding: 8px; margin: 5px 0; background: white;">
                <strong>[${log.timestamp}]</strong> ${log.message}
            </div>`
        ).join('');
        output.scrollTop = output.scrollHeight;
    }
    
    function clearLogs() {
        logs.length = 0;
        updateDebugOutput();
    }
    
    function addTestData() {
        const testCart = {
            items: {
                "1": { name: "Debug Pizza", qty: 2, price: 15.99 },
                "2": { name: "Debug Burger", qty: 1, price: 12.50 },
                "3": { name: "Debug Salad", qty: 3, price: 8.75 }
            }
        };
        
        localStorage.setItem('cart_v1', JSON.stringify(testCart));
        console.log('✅ Added test data to localStorage');
        console.log('Test cart data:', testCart);
    }
    
    function checkScripts() {
        console.log('=== Script Check ===');
        console.log('cartApiGet available:', typeof window.cartApiGet);
        console.log('cartApiAdd available:', typeof window.cartApiAdd);
        console.log('cartApiRemove available:', typeof window.cartApiRemove);
        console.log('renderCartBadges available:', typeof window.renderCartBadges);
        console.log('__CART_RENDER_BOUND__:', window.__CART_RENDER_BOUND__);
        
        // Check if cart-render.js functions are available
        const scripts = Array.from(document.scripts).map(s => s.src).filter(s => s);
        console.log('Loaded scripts with cart:', scripts.filter(s => s.includes('cart')));
        
        // Check localStorage
        const cartV1 = localStorage.getItem('cart_v1');
        if (cartV1) {
            try {
                const parsed = JSON.parse(cartV1);
                console.log('localStorage cart_v1 found:', parsed);
            } catch (e) {
                console.error('localStorage cart_v1 parse error:', e);
            }
        } else {
            console.log('No cart_v1 in localStorage');
        }
    }
    
    async function testCartRender() {
        console.log('=== Testing Cart Render ===');
        
        // Check if cartApiGet works
        if (typeof window.cartApiGet === 'function') {
            try {
                console.log('Calling cartApiGet...');
                const result = await window.cartApiGet();
                console.log('cartApiGet result:', result);
                
                if (result.items && result.items.length > 0) {
                    console.log('✅ Found', result.items.length, 'items in cart');
                    result.items.forEach((item, index) => {
                        console.log(`Item ${index + 1}:`, item);
                    });
                } else {
                    console.log('⚠️ No items found in cart');
                }
            } catch (error) {
                console.error('❌ cartApiGet error:', error);
            }
        } else {
            console.error('❌ cartApiGet function not available');
        }
        
        // Check cart-items div
        const cartDiv = document.getElementById('cart-items');
        if (cartDiv) {
            console.log('✅ cart-items div found');
            console.log('Current content length:', cartDiv.innerHTML.length, 'characters');
            if (cartDiv.innerHTML.trim()) {
                console.log('Content preview:', cartDiv.innerHTML.substring(0, 200) + '...');
            } else {
                console.log('⚠️ cart-items div is empty');
            }
        } else {
            console.error('❌ cart-items div not found');
        }
    }
    
    // Log when page loads
    window.addEventListener('load', () => {
        console.log('🚀 Page loaded');
        setTimeout(() => {
            checkScripts();
        }, 500);
    });
    
    // Log when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        console.log('📄 DOM ready');
    });
    
    console.log('🔧 Debug script initialized');
</script>
{% endblock %}