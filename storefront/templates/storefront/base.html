{% comment %} rms-back/templates/storefront/base.html {% endcomment %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}Storefront{% endblock %}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;margin:0;background:#0f1115;color:#e7e9ee}
    header,footer{background:#14151d;padding:12px 16px;position:sticky;top:0;z-index:30}
    a{color:#7c5cff;text-decoration:none}
    .container{max-width:1000px;margin:0 auto;padding:12px 16px;}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .card{background:#171925;border:1px solid #1e2130;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
    .card img{width:100%;height:160px;object-fit:cover}
    .btn{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid #2a2d3d;background:#1a1c27;color:#e7e9ee;cursor:pointer}
    .btn.primary{background:#7c5cff;border-color:#7c5cff;color:white}
    .row{display:flex;gap:8px;align-items:center}
    .cartbar{position:fixed;bottom:12px;left:0;right:0;display:flex;justify-content:center;z-index:40}
    .cartbar .inner{background:#171925;border:1px solid #2a2d3d;box-shadow:0 8px 24px rgba(0,0,0,.35);border-radius:999px;padding:8px 14px;display:flex;gap:12px;align-items:center}
    .muted{color:#a7adbb}
    .price{font-weight:600}
    .qty{display:inline-flex;align-items:center;gap:8px}
    input[type='number'], select, input[type='text']{background:#14151d;border:1px solid #272a3b;border-radius:10px;color:#e7e9ee;padding:8px 10px}
    .toast-wrap{position:fixed;right:16px;bottom:16px;z-index:1200;display:flex;flex-direction:column;gap:8px}
    .toast{background:#171925;border:1px solid #2a2d3d;color:#e7e9ee;border-radius:10px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:.98}
  </style>
  {% block head %}{% endblock %}
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <div class="row" style="gap:12px">
        <a href="{% url 'storefront:menu_list' %}">üçΩÔ∏è Storefront</a>
        <a href="#" onclick="return navReserve()">Reserve Table</a>
        {% if user.is_authenticated %}
          <a href="{% url 'storefront:my_orders' %}">My Orders</a>
        {% endif %}
      </div>
      <div class="row" style="gap:8px">
        {% if user.is_authenticated %}
          <span class="muted">Hi, {{ user.get_username }}</span>
          <button class="btn" type="button" onclick="logoutNow()">Logout</button>
        {% else %}
          <button id="loginBtn" class="btn" type="button" onclick="openAuthModal()">Login / Sign up</button>
        {% endif %}
        <a class="btn" href="{% url 'storefront:cart_full' %}">View Cart</a>
      </div>
    </div>
  </header>

  {% block content %}{% endblock %}

  <div id="cartbar" class="cartbar">
    {% if cart %}
      {% include "storefront/_cart_bar.html" with cart=cart %}
    {% else %}
      <div class="inner" style="display:none"></div>
    {% endif %}
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Auth Modal -->
  <div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1100;align-items:center;justify-content:center">
    <div class="card" style="width:520px;max-width:94vw;max-height:80vh;overflow:auto;padding:12px 12px 14px">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="authTitle" style="margin:0">Login</h3>
        <button class="btn" type="button" onclick="closeAuthModal()">√ó</button>
      </div>
      <div>
        <form id="loginForm" class="auth-view">
          <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
            <input type="text" name="username" placeholder="Username" style="flex:1;min-width:200px" required>
            <input type="password" name="password" placeholder="Password" style="flex:1;min-width:200px" required>
          </div>
          <button class="btn primary" type="submit" style="width:100%">Login</button>
        </form>
        <form id="registerForm" class="auth-view" style="display:none">
          <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
            <input type="text" name="username" placeholder="Username" style="flex:1;min-width:200px" required>
            <input type="email" name="email" placeholder="Email (optional)" style="flex:1;min-width:200px">
            <input type="password" name="password" placeholder="Password" style="flex:1;min-width:200px" required>
          </div>
          <button class="btn primary" type="submit" style="width:100%">Create Account</button>
        </form>
        <div class="muted" style="margin-top:8px;text-align:center">
          <span id="authToggleText">Don't have an account? <a href="#" onclick="return setAuthMode('register')">Sign up</a></span>
        </div>
      </div>
    </div>
    <div onclick="closeAuthModal()" style="position:absolute;inset:0"></div>
    <style>
      /* Ensure the modal card is above the click-to-close overlay */
      #authModal .card { position: relative; z-index: 1101; }
      #authModal > div:last-child { z-index: 1100; }
    </style>
  </div>

  <script>
    // --- UI helpers: Toasts and busy states ---
    function showToast(message, type){
      try{
        const wrap = document.getElementById('toastWrap');
        if (!wrap) { alert(message); return; }
        const div = document.createElement('div');
        div.className = 'toast';
        const colors = { success:'#166534', error:'#b91c1c', info:'#2563eb', warning:'#b45309' };
        div.style.borderLeft = `4px solid ${colors[type]||colors.info}`;
        div.textContent = String(message||'');
        wrap.appendChild(div);
        setTimeout(()=>{ try{ wrap.removeChild(div); }catch(_){} }, 4200);
      }catch(_){ /* fallback */ alert(message); }
    }
    function setBusy(btn, busy, label){
      if (!btn) return;
      if (busy){
        btn.dataset.prevText = btn.textContent || '';
        btn.textContent = label || 'Working‚Ä¶';
        btn.disabled = true;
      } else {
        if (btn.dataset.prevText !== undefined){ btn.textContent = btn.dataset.prevText; delete btn.dataset.prevText; }
        btn.disabled = false;
      }
    }
    function refreshCart(){ document.body.dispatchEvent(new Event('cart:changed')); }
    // Generic AJAX form handler usable across pages
    async function handleCartForm(ev){
      ev.preventDefault();
      const form = ev.target;
      const url = form.getAttribute('action');
      const fd = new FormData(form);
      try{
        const res = await fetch(url, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}, body: fd });
        const ct = res.headers.get('content-type') || '';
        const data = ct.includes('application/json') ? await res.json().catch(()=>null) : null;
        if (data){
          if (data.cart){ const el = document.getElementById('cartItems'); if (el) el.innerHTML = data.cart; }
          if (data.totals){ const el = document.getElementById('cartTotals'); if (el) el.innerHTML = data.totals; }
          if (data.options){ const el = document.getElementById('orderOptions'); if (el) el.innerHTML = data.options; }
          if (data.bar){ const el = document.getElementById('cartbar'); if (el) el.innerHTML = data.bar; }
          if (data.table_modal){ const el = document.getElementById('tableModalContent'); if (el){ el.innerHTML = data.table_modal; openTableModal?.(); } }
          if (url.includes('/cart/add/')){ showToast('Added to cart'); }
        }
      } catch(e){ console.warn('Form submit failed', e); }
      refreshCart();
      return false;
    }
    function showToast(msg){
      try{
        const wrap = document.getElementById('toastWrap');
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = msg;
        wrap.appendChild(el);
        setTimeout(()=>{ el.style.opacity = '0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(), 350); }, 1600);
      }catch(e){ /* noop */ }
    }
    // Delegate all .js-ajax forms to handleCartForm
    document.addEventListener('submit', function(ev){
      const form = ev.target;
      if (form && form.matches('form.js-ajax')){
        handleCartForm(ev);
      }
    }, true);
    // ---- Auth modal helpers ----
    function csrfToken(){
      // Prefer cookie, but if HttpOnly is enabled, fall back to hidden input
      try{
        const m = document.cookie.match(/csrftoken=([^;]+)/);
        if (m) return decodeURIComponent(m[1]);
      }catch(_){ /* ignore */ }
      const inp = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (inp && inp.value) return inp.value;
      // Last-resort template fallback
      return '{{ csrf_token }}';
    }
    function openAuthModal(mode){
      const m = document.getElementById('authModal');
      m.style.display = 'flex';
      setAuthMode(mode === 'register' ? 'register' : 'login');
    }
    // Convenience: open directly to Sign up mode
    function openSignUpModal(){ return openAuthModal('register'); }
    function closeAuthModal(){ const m=document.getElementById('authModal'); m.style.display='none'; }
    function setAuthMode(mode){
      const l=document.getElementById('loginForm'); const r=document.getElementById('registerForm'); const t=document.getElementById('authTitle'); const tx=document.getElementById('authToggleText');
      if (mode==='register'){ l.style.display='none'; r.style.display='block'; t.textContent='Sign up'; tx.innerHTML = "Already have an account? <a href='#' onclick=\"return setAuthMode('login')\">Login</a>"; }
      else { l.style.display='block'; r.style.display='none'; t.textContent='Login'; tx.innerHTML = "Don't have an account? <a href='#' onclick=\"return setAuthMode('register')\">Sign up</a>"; }
      return false;
    }
    function toggleAuthMode(){ const r=document.getElementById('registerForm'); return setAuthMode(r.style.display==='none'?'register':'login'); }
    async function submitLogin(ev){ ev.preventDefault(); const f=ev.target; const payload={ username:f.username.value.trim(), password:f.password.value }; if(!payload.username||!payload.password){ showToast('Please enter username and password','warning'); return }
      const btn = f.querySelector('button[type="submit"]'); setBusy(btn,true,'Logging in‚Ä¶');
      try{
        const res = await fetch('{% url "accounts:login_json" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken(),'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin', body: JSON.stringify(payload)});
        let data = null; const ct = res.headers.get('content-type')||''; if (ct.includes('application/json')){ data = await res.json().catch(()=>null); }
        if(!res.ok){ showToast((data && data.detail) ? data.detail : 'Login failed','error'); return; }
        // Merge guest cart into user cart then proceed
        await mergeCartAfterLogin();
        closeAuthModal(); refreshCartBar(); document.body.dispatchEvent(new Event('auth:loggedin'));
        showToast('Welcome back!','success');
        if (window._postAuthAction === 'checkout' && typeof beginCheckout === 'function'){ window._postAuthAction = null; beginCheckout(); }
        else if (window._postAuthAction === 'reserve'){ window._postAuthAction = null; window.location.href = '{% url "reservations_portal:page" %}'; }
      } catch(e){ console.error(e); showToast('Login failed','error'); }
      finally { setBusy(btn,false); }
      return false;
    }
    async function submitRegister(ev){ ev.preventDefault(); const f=ev.target; const payload={ username:f.username.value.trim(), email:(f.email?.value||'').trim(), password:f.password.value }; if(!payload.username||!payload.password){ showToast('Please enter username and password','warning'); return }
      const btn = f.querySelector('button[type="submit"]'); setBusy(btn,true,'Creating‚Ä¶');
      try{
        const res = await fetch('{% url "accounts:register_json" %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken(),'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin', body: JSON.stringify(payload)});
        let data = null; const ct = res.headers.get('content-type')||''; if (ct.includes('application/json')){ data = await res.json().catch(()=>null); }
        if(!res.ok){ showToast((data && data.detail) ? data.detail : 'Registration failed','error'); return; }
        // Merge guest cart into new user cart then proceed
        await mergeCartAfterLogin();
        closeAuthModal(); refreshCartBar(); document.body.dispatchEvent(new Event('auth:loggedin'));
        showToast('Account created!','success');
        if (window._postAuthAction === 'checkout' && typeof beginCheckout === 'function'){ window._postAuthAction = null; beginCheckout(); }
        else if (window._postAuthAction === 'reserve'){ window._postAuthAction = null; window.location.href = '{% url "reservations_portal:page" %}'; }
      } catch(e){ console.error(e); showToast('Registration failed','error'); }
      finally { setBusy(btn,false); }
      return false;
    }
    async function logoutNow(){ try{ await fetch('{% url "accounts:logout_json" %}', {method:'POST', headers:{'X-CSRFToken': csrfToken()}}); location.reload(); }catch(e){ location.reload(); } }
    // Bind forms if modal exists
    document.addEventListener('DOMContentLoaded', ()=>{
      const lf=document.getElementById('loginForm'); if(lf){ lf.addEventListener('submit', submitLogin); }
      const rf=document.getElementById('registerForm'); if(rf){ rf.addEventListener('submit', submitRegister); }
    });
    // Listen for auth required prompts
    window.addEventListener('auth:required', ()=>{ window._postAuthAction = window._postAuthAction || 'checkout'; openAuthModal(); });
    async function refreshCartBar(){
      try{
        const res = await fetch('{% url "storefront:cart_bar" %}', { headers: {'X-Requested-With':'XMLHttpRequest'} });
        const html = await res.text();
        const el = document.getElementById('cartbar');
        el.innerHTML = html;
      } catch(e){ console.warn('Cart bar refresh failed', e); }
    }
    document.addEventListener('DOMContentLoaded', refreshCartBar);
    document.body.addEventListener('cart:changed', refreshCartBar);

    // Merge helper: asks server to merge session cart into user cart post-auth
    async function mergeCartAfterLogin(){
      try{
        await fetch('{% url "storefront:cart_merge_session" %}', { method:'POST', headers:{'X-CSRFToken': csrfToken(),'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin' });
      }catch(e){ /* non-fatal */ }
    }

    // Nav: Reserve Table link
    function navReserve(){
      try{
        // If logged in, go to portal
        {% if user.is_authenticated %}
          window.location.href = '{% url "reservations_portal:page" %}';
          return false;
        {% else %}
          // Prompt login then jump to portal
          window._postAuthAction = 'reserve';
          openAuthModal('login');
          return false;
        {% endif %}
      }catch(e){ return true; }
    }
  </script>
  <!-- CSRF priming to ensure cookie is set -->
  <form style="display:none">{% csrf_token %}</form>
  {% block scripts %}{% endblock %}
</body>
</html>
