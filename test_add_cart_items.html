<!DOCTYPE html>
<html>
<head>
    <title>Add Cart Items Test</title>
    <script>
        // Define cartApiGet function (from base.html)
        window.cartApiGet = async function cartApiGet(){
            console.log('cartApiGet called');
            
            const r = await fetch("/api/orders/cart-simple/", { 
                credentials: "include"
            });
            
            let serverData = { items: [] };
            if (r.ok) {
                serverData = await r.json();
                console.log('Server data:', serverData);
            }
            
            if (!serverData.items || serverData.items.length === 0) {
                console.log('Server cart empty, checking localStorage');
                try {
                    const cartV1 = localStorage.getItem('cart_v1');
                    if (cartV1) {
                        const cart = JSON.parse(cartV1);
                        if (cart.items && typeof cart.items === 'object') {
                            const items = Object.entries(cart.items).map(([id, item]) => ({
                                id: parseInt(id),
                                name: item.name || `Item ${id}`,
                                quantity: item.qty || 0,
                                unit_price: item.price || 0,
                                line_total: (item.qty || 0) * (item.price || 0),
                                total_unit_price: item.price || 0,
                                modifier_price: 0,
                                modifier_names: []
                            }));
                            
                            return {
                                items: items,
                                subtotal: items.reduce((sum, item) => sum + (item.line_total || 0), 0).toFixed(2),
                                meta: cart
                            };
                        }
                    }
                } catch (e) {
                    console.error('Error reading cart_v1 from localStorage:', e);
                }
            }
            
            return serverData;
        }
    </script>
</head>
<body>
    <h1>Add Cart Items Test</h1>
    <button onclick="addTestItems()">Add Test Items to localStorage</button>
    <button onclick="checkCart()">Check Cart</button>
    <a href="/cart/">Go to Cart Page</a>
    
    <div id="output"></div>
    
    <script>
        function addTestItems() {
            // Use the cartApiAdd function if available
            if (typeof window.cartApiAdd === 'function') {
                // Add items using cartApiAdd
                window.cartApiAdd('1', 2); // This should add 2 of item 1
                window.cartApiAdd('2', 1); // This should add 1 of item 2
                window.cartApiAdd('3', 3); // This should add 3 of item 3
                
                document.getElementById('output').innerHTML = '<p style="color: green;">✅ Test items added using cartApiAdd!</p>';
                console.log('Added test items using cartApiAdd');
            } else {
                // Fallback to direct localStorage manipulation
                const testCart = {
                    items: {
                        "1": { name: "Margherita Pizza", qty: 2, price: 15.99 },
                        "2": { name: "Chicken Burger", qty: 1, price: 12.50 },
                        "3": { name: "Caesar Salad", qty: 3, price: 8.75 }
                    },
                    tip: 0,
                    discount: 0,
                    delivery: "DINE_IN"
                };
                
                localStorage.setItem('cart_v1', JSON.stringify(testCart));
                document.getElementById('output').innerHTML = '<p style="color: green;">✅ Test items added to localStorage!</p>';
                console.log('Added test items:', testCart);
            }
        
        function checkCart() {
            const cartData = localStorage.getItem('cart_v1');
            if (cartData) {
                const cart = JSON.parse(cartData);
                document.getElementById('output').innerHTML = '<pre>' + JSON.stringify(cart, null, 2) + '</pre>';
            } else {
                document.getElementById('output').innerHTML = '<p style="color: red;">❌ No cart data found</p>';
            }
        }
    </script>
    
    <!-- Load app.js for cart functionality -->
    <script src="/static/storefront/app.js"></script>
</body>
</html>